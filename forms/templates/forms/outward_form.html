<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Outward Tracking Form</title>
{% load static %}
<style>
/* Header */
.header {
  position: sticky;
  top: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px 40px;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-section img {
  height: 40px;
  filter: brightness(0) invert(1);
}

body{
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  margin:0;
  padding:20px 0;
}
.form-wrap{
  max-width:1100px;
  margin:30px auto;
  background:#fff;
  padding:40px;
  border-radius:12px;
  box-shadow:0 10px 40px rgba(0,0,0,0.2);
}

.top-button-bar {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

.top-button-bar button,
.top-button-bar a {
  padding: 10px 24px;
  border: 2px solid #667eea;
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  font-size: 15px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.top-button-bar button:hover,
.top-button-bar a:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}
h1{
  text-align:center;
  color:#667eea;
  margin-bottom:10px;
  font-size:30px;
  font-weight:700;
}
.req-note{
  text-align:center;
  color:#e74c3c;
  font-size:13px;
  margin-bottom:20px;
}
label{
  display:block;
  margin:18px 0 8px;
  font-size:14px;
  font-weight:600;
  color:#333;
}
.req{
  color:#e74c3c;
}
input,select{
  width:100%;
  padding:12px 14px;
  font-size:14px;
  border:2px solid #e0e0e0;
  border-radius:6px;
  box-sizing:border-box;
  background:#fafafa;
  transition:all 0.3s ease;
}
input:focus,select:focus{
  outline:none;
  border-color:#667eea;
  background:#fff;
  box-shadow:0 0 0 3px rgba(102,126,234,0.1);
}
select{
  cursor:pointer;
  appearance:none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat:no-repeat;
  background-position:right 10px center;
  background-size:20px;
  padding-right:36px;
}
button{
  width:100%;
  margin-top:28px;
  padding:14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color:#fff;
  font-size:16px;
  font-weight:700;
  border:none;
  border-radius:8px;
  cursor:pointer;
  box-shadow:0 4px 15px rgba(102,126,234,0.4);
  transition:all 0.3s ease;
}
button:hover{
  transform: translateY(-2px);
  box-shadow:0 6px 20px rgba(102,126,234,0.6);
}

.back-buttons {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.back-button, .home-button {
  flex: 1;
  min-width: 150px;
  padding: 12px;
  border: 2px solid #667eea;
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  font-size: 16px;
  font-weight: 700;
  border-radius: 8px;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.back-button:hover, .home-button:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}

/* Conditional field visibility */
.inverter-only {
  display: none;
}

.battery-only {
  display: none;
}

/* Hide browser validation popups */
input:invalid {
  box-shadow: none;
}

input::-webkit-validation-bubble-message {
  display: none;
}

.pcb-only {
  display: none;
}

.inverter-only.show,
.battery-only.show,
.pcb-only.show {
  display: block;
}

@media(max-width:600px){
  .form-wrap{
    margin:16px;
    padding:24px;
  }
}
  /* Dropdown suggestions styles moved here */
  .dropdown-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 2px solid #1a73e8;
    border-radius: 8px;
    max-height: 240px;
    overflow-y: auto;
    z-index: 2000;
    box-shadow: 0 8px 24px rgba(26,115,232,0.10), 0 1.5px 6px rgba(0,0,0,0.08);
    display: none;
    margin-top: 2px;
    animation: fadeIn 0.18s;
  }
  .dropdown-suggestions .dropdown-item {
    padding: 14px 20px;
    cursor: pointer;
    font-size: 17px;
    color: #1a237e;
    border-bottom: 1px solid #f0f4fa;
    transition: background 0.13s, color 0.13s;
    background: #fff;
  }
  .dropdown-suggestions .dropdown-item:last-child {
    border-bottom: none;
  }
  .dropdown-suggestions .dropdown-item:hover,
  .dropdown-suggestions .dropdown-item.active {
    background: linear-gradient(90deg, #e3f0fd 0%, #e8f3fc 100%);
    color: #0d47a1;
    font-weight: 600;
    border-left: 4px solid #1a73e8;
    padding-left: 16px;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>

<body>


<div class="header">
  <div class="logo-section">
    <a href="/" style="text-decoration: none;">
      <img src="{% static 'admin/Images/logo-deye-300x225.webp' %}" alt="DEYE">
    </a>
  </div>
</div>

{% if form_errors %}
<div style="background:#fdecea;color:#611a15;border:1px solid #f5c6cb;padding:8px 12px;border-radius:6px;margin:12px 0;">
  <strong>There were errors with your submission:</strong>
  <ul style="margin:8px 0 0 16px;">
    {% for field, errors in form_errors.items %}
      <li><b>{{ field|capfirst }}</b>: {{ errors|join:', ' }}</li>
    {% endfor %}
  </ul>
  <div style="font-size:12px;opacity:.8;">Please correct them and submit again.</div>
</div>
{% endif %}

<form class="form-wrap" method="post">
{% csrf_token %}

<div class="top-button-bar">
  <button type="button" onclick="history.back()">‚Üê Go Back</button>
  <a href="/">üè† Back to Home</a>
</div>

<h1>Outward Tracking</h1>
<div class="req-note">* Indicates required question</div>

<label style="background:#e8f0fe;padding:12px;border-left:4px solid #667eea;border-radius:4px;font-size:16px;font-weight:700;">üîç AWB Number (Search & Auto-Fill)<span class="req">*</span></label>
<input type="text" class="outward-awb-input" name="awb_number" list="outward-awb-suggestions" placeholder="Type AWB number to search and auto-fill details" required style="font-size:16px;font-weight:600;">
<div style="font-size:12px;color:#666;margin:6px 0 12px 0;">Enter AWB from logistics booking. Outward details will auto-fill.</div>

<div id="outward-awb-item-container" style="display:none; margin:-2px 0 20px 0;">
  <label style="background:#fff7ed;padding:10px;border-left:4px solid #fb923c;border-radius:4px;font-size:14px;font-weight:700;">üì¶ Select Item For This AWB<span class="req">*</span></label>
  <select id="outward-awb-item-select" style="margin-top:8px;" disabled>
    <option value="">Select item</option>
  </select>
  <div style="font-size:12px;color:#7c2d12;margin-top:6px;">This AWB has multiple items. Select one item to fill exact outward details.</div>
</div>

<datalist id="outward-awb-suggestions"></datalist>

<label>Sent By <span class="req">*</span></label>
<select name="sent_by" required>
<option value="">Select</option>
<option>Shrikant</option>
<option>Rushikesh</option>
<option>Sagar K</option>
<option>Arun</option>
<option>Vinayak</option>
<option>Bhuvan</option>
<option>Sandeep</option>
<option>Pranav</option>
<option>Jayesh</option>
<option>Sanjay</option>
<option>Mukesh</option>
</select>

<label>Approved By <span class="req">*</span></label>
<select name="approved_by" required>
<option value="">Select</option>
<option>Sagar K</option>
<option>Tanaji</option>
<option>Mahammad</option>
<option>Snehal</option>
<option>Sandeep</option>
<option>Akshay Sir</option>
<option>Bhuvan</option>
<option>Pranav</option>
<option>Rakesh</option>
</select>

<label>Company Abbreviation <span class="req">*</span></label>
<select name="company_abbrev" required>
<option value="">Select</option>
<option>Alternative Energy</option>
   <option>Alternative Energy</option>
        <option>Aps</option>
        <option>Arkay Solar</option>
        <option>Avirat Energy</option>
        <option>Brither World Engineering Works</option>
        <option>Banglore</option>
        <option>Ceyone Solar</option>
        <option>Chetanbhai Trimandir</option>
        <option>Deye</option>
        <option>Eco Active Energy & Solution</option>
        <option>Envest Energy Solutions Llp</option>
        <option>Evaanta Solar</option>
        <option>Evvo</option>
        <option>Ferus Solar Energy Solution</option>
        <option>Feston</option>
        <option>Fine Vibes Renewable Pvt Ltd (Cg)</option>
        <option>Glowx</option>
        <option>Green Energy</option>
        <option>Green Era</option>
        <option>Green Watt Energy</option>
        <option>Greenedge</option>
        <option>Gujarat Energy</option>
        <option>Invergy</option>
        <option>Jaffins Enterprise</option>
        <option>Jay Aditya Solar</option>
        <option>Kerala Office</option>
        <option>Ksolare</option>
        <option>Madhav Enterprise</option>
        <option>Madhya Pradesh Solar9</option>
        <option>Mindra</option>
        <option>Mp Engineering</option>
        <option>Navi Energy</option>
        <option>Next Tech Solar Energy</option>
        <option>Nil Electronics</option>
        <option>Nk Construction</option>
        <option>Powerone</option>
        <option>Pushan Renewable Energy Pvt Ltd</option>
        <option>Radiant Sun Energy</option>
        <option>Railway Station Dhanera</option>
        <option>Roshni Solar</option>
        <option>Rudra Solar</option>
        <option>Saan Electrical</option>
        <option>Shantimani Enterprises</option>
        <option>Smart Solar Bidgely Solution Pvt Ltd</option>
        <option>Solaryaan</option>
        <option>Suntech Energy</option>
        <option>Swami Solar</option>
        <option>Symbroz Solar  Pvt Ltd</option>
        <option>Tecnogoods Energy</option>
        <option>Trambaka Solar  Pvt Ltd</option>
        <option>Urja Strot</option>
        <option>Utl</option>
        <option>Utl Solar</option>
        <option>Vsole</option>
        <option>Waaree</option>
        <option>Water Sun Solar</option>
        <option>Watthut</option>
        <option>Yamas Solar</option>
        <option>Other</option>
</select>

<label>Outward Object <span class="req">*</span></label>
<select name="outward_object" id="outwardObject" required>
<option value="">Select</option>
<option value="Inverter">Inverter</option>
<option value="Battery">Battery</option>
<option value="PCB">PCB</option>
</select>

<label>Inverter Sent To Company Name <span class="req">*</span></label>
<input type="text" name="sent_to_company" required>

<label>Pincode <span class="req">*</span></label>
<input type="text" name="pincode" required placeholder="Enter 6-digit pincode">

<label>Sent To Address <span class="req">*</span></label>
<input type="text" name="sent_to_address" required readonly style="background-color: #f0f0f0;">

<label>Sent To District <span class="req">*</span></label>
<input type="text" name="sent_to_district" required readonly style="background-color: #f0f0f0;">

<label>Sent To State <span class="req">*</span></label>
<select name="sent_to_state" required disabled style="background-color: #f0f0f0;">
<option value="">Select</option>
<option>Andhra Pradesh</option>
<option>Arunachal Pradesh</option>
<option>Assam</option>
<option>Bihar</option>
<option>Chhattisgarh</option>
<option>Goa</option>
<option>Gujarat</option>
<option>Haryana</option>
<option>Himachal Pradesh</option>
<option>Jharkhand</option>
<option>Karnataka</option>
<option>Kerala</option>
<option>Madhya Pradesh</option>
<option>Maharashtra</option>
<option>Manipur</option>
<option>Meghalaya</option>
<option>Mizoram</option>
<option>Nagaland</option>
<option>Odisha</option>
<option>Punjab</option>
<option>Rajasthan</option>
<option>Sikkim</option>
<option>Tamil Nadu</option>
<option>Telangana</option>
<option>Tripura</option>
<option>Uttar Pradesh</option>
<option>Uttarakhand</option>
<option>West Bengal</option>
<option>Other - Jammu & Kashmir</option>
</select>

<div class="inverter-only">
  <div class="accessories-section" style="margin-top:18px; margin-bottom:18px;">
    <label style="font-weight:600; font-size:15px; margin-bottom:8px; display:block;">Accessories (optional)</label>
    <div style="display:flex; gap:32px; align-items:center;">
      <div style="display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="accessory_data_logger" name="accessories" value="data_logger" style="margin:0;">
        <label for="accessory_data_logger" style="font-weight:400; font-size:14px; margin:0;">Data Logger</label>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="accessory_stand" name="accessories" value="stand" style="margin:0;">
        <label for="accessory_stand" style="font-weight:400; font-size:14px; margin:0;">Stand</label>
      </div>
    </div>
  </div>
</div>


<div class="inverter-only">
  <label>Inverter ID ‚Äì Outward</label>
  <div style="position:relative; width:100%;">
    <input type="text" name="inverter_id_outward" id="inverterIdOutward" autocomplete="off" placeholder="Type to search serial..." style="width:100%;">
    <div id="dropdown-inverter-suggestions" class="dropdown-suggestions"></div>
  </div>

  <label>Inverter Specification <span class="req">*</span></label>
  <select name="inverter_spec" id="inverterSpec">
    <option value="">Select</option>
    <option>1PH - Hybrid</option>
    <option>3PH - Hybrid</option>
    <option>1PH - Ongrid</option>
    <option>3PH - Ongrid</option>
    <option>All In One - Hybrid</option>
    <option>Micro Inverter</option>
  </select>

  <label>Inverter Rating</label>
  <select name="inverter_rating" id="inverterRating">
    <option value="">Select</option>
    <option>2.2 KW</option>
    <option>3 KW</option>
    <option>3.3 KW</option>
    <option>4 KW</option>
    <option>5 KW</option>
    <option>6 KW</option>
    <option>8 KW</option>
    <option>10 KW</option>
    <option>12 KW</option>
    <option>15 KW</option>
    <option>18 KW</option>
    <option>20 KW</option>
    <option>25 KW</option>
    <option>30 KW</option>
    <option>33 KW</option>
    <option>35 KW</option>
    <option>40 KW</option>
    <option>50 KW</option>
    <option>60 KW</option>
    <option>75 KW</option>
    <option>80 KW</option>
    <option>100 KW</option>
    <option>125 KW</option>
    <option>136 KW</option>
  </select>
</div>
  <!-- Control Card Changed Section (only for Inverter) -->
  <div id="controlCardChangedSection" style="margin-top:18px; margin-bottom:10px; display:none;">
    <label for="control_card_changed" style="font-weight:500; font-size:14px;">Control Card Changed</label>
    <select name="control_card_changed" id="controlCardChanged" style="margin-top:6px; width:100%;">
      <option value="">Select</option>
      <option value="No">No</option>
      <option value="Yes">Yes</option>
    </select>
  </div>
  <div id="newSerialNumberDiv" style="display:none; margin-bottom:18px;">
    <label for="new_serial_number" style="font-weight:500; font-size:14px;">New Serial Number <span class="req">*</span></label>
    <input type="text" name="new_serial_number" id="newSerialNumber" style="margin-top:6px; width:100%;" maxlength="100" placeholder="Enter new serial number">
  </div>
  <!-- Replacement Type (only for Inverter) -->
  <div id="replacementTypeDiv" style="display:none; margin-bottom:18px;">
    <label for="replacement_type" style="font-weight:500; font-size:14px;">Replacement Type <span class="req">*</span></label>
    <select name="replacement_type" id="replacementType" style="margin-top:6px; width:100%;">
      <option value="">Select</option>
      <option value="Warranty">Yes</option>
      <option value="Out of Warranty">No</option>
    </select>
  </div>
  <!-- Inward Inverter ID (only if Replacement Type selected) -->
  <div id="inwardInverterIdDiv" style="display:none; margin-bottom:18px;">
    <label for="inverter_id_inward" style="font-weight:500; font-size:14px; margin-top:10px;">Inward Inverter ID <span class="req">*</span></label>
    <input type="text" name="inverter_id_inward" id="inverterIdInward" style="margin-top:6px; width:100%;" maxlength="255" placeholder="Enter Inward Inverter ID">
  </div>
</div>

<div class="battery-only">
  <label>Battery ID <span class="req">*</span> (with dropdown-style autocomplete)</label>
  <div style="position:relative; width:100%;">
    <input type="text" name="battery_id" id="batteryIdOutward" autocomplete="off" placeholder="Type to search battery serial..." style="width:100%;">
    <div id="dropdown-battery-suggestions" class="dropdown-suggestions"></div>
  </div>

  <label>Battery Model</label>
  <select name="battery">
    <option value="">Select</option>
    <option>RW - L 2.5 Neutral</option>
    <option>RW - M 5.3 Neutral</option>
    <option>RW - M 5.3 Pro Neutral (M6)</option>
    <option>RW - M 6.1 Neutral</option>
    <option>RW - M 6.1 B Neutral No Remark</option>
    <option>SE - G 5.1 - Pro B Neutral No Remark</option>
    <option>AI - W 5.1 Neutral</option>
    <option>AI - W 5.1 - B Neutral No Remark</option>
    <option>BOS - GM 5.1 Neutral</option>
    <option>GB - LM 4.0 Neutral</option>
    <option>GB - LB Neutral</option>
    <option>SE - G 5.3</option>
    <option>SE - G 5.3 Pro</option>
    <option>SE - F 5</option>
    <option>Other</option>
  </select>
</div>

<div class="pcb-only">
<label>PCB Serial Number <span class="req">*</span></label>
<input type="text" name="pcb_serial_number" required>

<label>No of Quantity <span class="req">*</span></label>
<input type="number" name="pcb_quantity" required min="1">

<label>PCB Ratings</label>
<select name="pcb_rating">
<option value="">Select</option>
<option>2.2 KW</option>
<option>3 KW</option>
<option>3.3 KW</option>
<option>4 KW</option>
<option>5 KW</option>
<option>6 KW</option>
<option>8 KW</option>
<option>10 KW</option>
<option>12 KW</option>
<option>15 KW</option>
<option>18 KW</option>
<option>20 KW</option>
<option>25 KW</option>
<option>30 KW</option>
<option>33 KW</option>
<option>35 KW</option>
<option>40 KW</option>
<option>50 KW</option>
<option>60 KW</option>
<option>75 KW</option>
<option>80 KW</option>
<option>100 KW</option>
<option>125 KW</option>
<option>136 KW</option>
</select>

<label>PCB Specifications</label>
<select name="pcb_specification">
<option value="">Select</option>
<option>1PH - Hybrid</option>
<option>3PH - Hybrid</option>
<option>1PH - Ongrid</option>
<option>3PH - Ongrid</option>
<option>All In One - Hybrid</option>
<option>Micro Inverter</option>
</select>
</div>

<label>Delivered Through <span class="req">*</span></label>
<select name="delivered_through" required>
<option value="">Select</option>
<option>Bigship</option>
<option>Blue Dart</option>
<option>Anjani</option>
<option>Delhivery</option>
<option>Safexpress</option>
<option>Global Cargo</option>
<option>Other</option>
</select>

<button type="submit">Submit</button>

</form>

<script>

const outwardAwbInput = document.querySelector('.outward-awb-input');
const outwardAwbDatalist = document.getElementById('outward-awb-suggestions');
const outwardAwbItemContainer = document.getElementById('outward-awb-item-container');
const outwardAwbItemSelect = document.getElementById('outward-awb-item-select');
let outwardAwbItemsCache = [];

function normalizeOutwardText(value) {
  return (value || '').toString().trim().toLowerCase().replace(/\s+/g, ' ').replace(/-/g, ' ').replace(/_/g, ' ');
}

function outwardSelectByValueOrText(selectEl, rawValue) {
  if (!selectEl || !rawValue) return false;
  const wanted = normalizeOutwardText(rawValue);
  for (const option of selectEl.options) {
    const optionValue = normalizeOutwardText(option.value);
    const optionText = normalizeOutwardText(option.text);
    if (optionValue === wanted || optionText === wanted) {
      selectEl.value = option.value;
      return true;
    }
  }
  return false;
}

function outwardBuildItemLabel(item, index) {
  const parts = [];
  parts.push(`Item ${index + 1}`);
  if (item.object_type) parts.push(item.object_type);
  if (item.object_variant) parts.push(item.object_variant);
  if (item.object_capacity) parts.push(item.object_capacity);
  if (item.object_serial_number) parts.push(`SN: ${item.object_serial_number}`);
  if (item.object_quantity) parts.push(`Qty: ${item.object_quantity}`);
  return parts.join(' | ');
}

function outwardResetItemSelector() {
  outwardAwbItemsCache = [];
  if (!outwardAwbItemSelect) return;
  outwardAwbItemSelect.innerHTML = '<option value="">Select item</option>';
  outwardAwbItemSelect.disabled = true;
  if (outwardAwbItemContainer) outwardAwbItemContainer.style.display = 'none';
}

function outwardRenderItemSelector(items) {
  if (!outwardAwbItemSelect) return;
  outwardAwbItemsCache = Array.isArray(items) ? items : [];

  if (outwardAwbItemsCache.length <= 1) {
    outwardAwbItemSelect.innerHTML = '<option value="">Select item</option>';
    outwardAwbItemSelect.disabled = true;
    if (outwardAwbItemContainer) outwardAwbItemContainer.style.display = 'none';
    return;
  }

  outwardAwbItemSelect.innerHTML = '<option value="">Select item</option>';
  outwardAwbItemsCache.forEach((item, idx) => {
    const option = document.createElement('option');
    option.value = String(item.booking_id || idx);
    option.dataset.index = String(idx);
    option.textContent = outwardBuildItemLabel(item, idx);
    outwardAwbItemSelect.appendChild(option);
  });
  outwardAwbItemSelect.disabled = false;
  if (outwardAwbItemContainer) outwardAwbItemContainer.style.display = 'block';
}

function fillOutwardFromAwbItem(detail) {
  if (!detail) return;

  if (outwardAwbInput && detail.awb_number) {
    outwardAwbInput.value = detail.awb_number;
  }

  const outwardObject = document.getElementById('outwardObject');
  if (outwardObject && detail.object_type) {
    outwardSelectByValueOrText(outwardObject, detail.object_type);
    if (typeof toggleOutwardFields === 'function') {
      toggleOutwardFields();
    }
    if (typeof toggleAccessoriesSection === 'function') {
      toggleAccessoriesSection();
    }
    if (typeof toggleControlCardChangedSection === 'function') {
      toggleControlCardChangedSection();
    }
  }

  const sentToCompany = document.querySelector('input[name="sent_to_company"]');
  if (sentToCompany) {
    sentToCompany.value = detail.delivery_name || detail.customer_name || sentToCompany.value;
  }

  const pincodeInput = document.querySelector('input[name="pincode"]');
  if (pincodeInput && detail.delivery_pincode) {
    pincodeInput.value = detail.delivery_pincode;
  }

  const sentToState = document.querySelector('select[name="sent_to_state"]');
  if (sentToState && detail.delivery_state) {
    sentToState.disabled = false;
    outwardSelectByValueOrText(sentToState, detail.delivery_state);
    sentToState.disabled = true;
  }

  const sentToDistrict = document.querySelector('input[name="sent_to_district"]');
  if (sentToDistrict && detail.delivery_district) {
    sentToDistrict.value = detail.delivery_district;
  }

  const sentToAddress = document.querySelector('input[name="sent_to_address"]');
  if (sentToAddress) {
    sentToAddress.value = detail.delivery_address || detail.delivery_city || sentToAddress.value;
  }

  const deliveredThrough = document.querySelector('select[name="delivered_through"]');
  if (deliveredThrough && detail.courier_partner) {
    if (!outwardSelectByValueOrText(deliveredThrough, detail.courier_partner)) {
      outwardSelectByValueOrText(deliveredThrough, 'Other');
    }
  }

  const inverterId = document.getElementById('inverterIdOutward');
  if (inverterId && detail.object_type === 'Inverter' && detail.object_serial_number) {
    inverterId.value = detail.object_serial_number;
  }

  const inverterSpec = document.getElementById('inverterSpec');
  if (inverterSpec && detail.object_type === 'Inverter' && detail.object_variant) {
    outwardSelectByValueOrText(inverterSpec, detail.object_variant);
  }

  const inverterRating = document.getElementById('inverterRating');
  if (inverterRating && detail.object_type === 'Inverter' && detail.object_capacity) {
    outwardSelectByValueOrText(inverterRating, detail.object_capacity);
  }

  const batteryId = document.getElementById('batteryIdOutward');
  if (batteryId && detail.object_type === 'Battery' && detail.object_serial_number) {
    batteryId.value = detail.object_serial_number;
  }

  const batteryModel = document.querySelector('select[name="battery"]');
  if (batteryModel && detail.object_type === 'Battery' && detail.object_variant) {
    outwardSelectByValueOrText(batteryModel, detail.object_variant);
  }

  const pcbSerial = document.querySelector('input[name="pcb_serial_number"]');
  if (pcbSerial && detail.object_type === 'PCB' && detail.object_serial_number) {
    pcbSerial.value = detail.object_serial_number;
  }

  const pcbQty = document.querySelector('input[name="pcb_quantity"]');
  if (pcbQty && detail.object_type === 'PCB' && detail.object_quantity) {
    pcbQty.value = detail.object_quantity;
  }

  const pcbSpecs = document.querySelector('select[name="pcb_specification"]');
  if (pcbSpecs && detail.object_type === 'PCB' && detail.object_variant) {
    outwardSelectByValueOrText(pcbSpecs, detail.object_variant);
  }

  const pcbRatings = document.querySelector('select[name="pcb_rating"]');
  if (pcbRatings && detail.object_type === 'PCB' && detail.object_capacity) {
    outwardSelectByValueOrText(pcbRatings, detail.object_capacity);
  }
}

function updateOutwardAwbSuggestions(value) {
  if (!outwardAwbInput || !outwardAwbDatalist) return;
  if (!value) {
    outwardAwbDatalist.innerHTML = '';
    outwardResetItemSelector();
  }

  fetch('/api/awb-lookup/?q=' + encodeURIComponent(value || ''))
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(j => {
      if (!j || !j.ok) return;
      outwardAwbDatalist.innerHTML = '';
      (j.suggestions || []).forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        outwardAwbDatalist.appendChild(opt);
      });

      const items = Array.isArray(j.items) ? j.items : [];
      outwardRenderItemSelector(items);

      if (items.length === 1) {
        fillOutwardFromAwbItem(items[0]);
      } else if (items.length === 0 && j.detail) {
        fillOutwardFromAwbItem(j.detail);
      }
    })
    .catch(err => {
      console.error('Outward AWB lookup error:', err);
    });
}

if (outwardAwbInput) {
  outwardAwbInput.setAttribute('autocomplete', 'off');
  outwardAwbInput.addEventListener('focus', (e) => updateOutwardAwbSuggestions(e.target.value || ''));
  outwardAwbInput.addEventListener('input', (e) => updateOutwardAwbSuggestions(e.target.value));
  outwardAwbInput.addEventListener('change', (e) => updateOutwardAwbSuggestions(e.target.value));
}

if (outwardAwbItemSelect) {
  outwardAwbItemSelect.addEventListener('change', (e) => {
    const selectedIndex = e.target.selectedOptions && e.target.selectedOptions[0]
      ? Number(e.target.selectedOptions[0].dataset.index)
      : -1;
    if (selectedIndex >= 0 && outwardAwbItemsCache[selectedIndex]) {
      fillOutwardFromAwbItem(outwardAwbItemsCache[selectedIndex]);
    }
  });
}

// Toggle conditional fields based on Outward Object selection
function toggleOutwardFields() {
  const outwardObject = document.querySelector('#outwardObject').value;
  // Hide all conditional sections
  document.querySelectorAll('.inverter-only, .battery-only, .pcb-only').forEach(section => {
    section.classList.remove('show');
  });
  // Handle each object type
  
  if (outwardObject === 'Inverter') {
    document.querySelectorAll('.inverter-only').forEach(section => section.classList.add('show'));
    // Set required for inverter fields
    document.getElementById('inverterIdOutward').setAttribute('required', 'required');
    document.getElementById('inverterSpec').setAttribute('required', 'required');
  } else {
    // Remove required for inverter fields
    document.getElementById('inverterIdOutward').removeAttribute('required');
    document.getElementById('inverterSpec').removeAttribute('required');
  }
  if (outwardObject === 'Battery') {
    document.querySelector('.battery-only').classList.add('show');
  }
  if (outwardObject === 'PCB') {
    document.querySelector('.pcb-only').classList.add('show');
  }
}
  
  // Show/hide Control Card Changed and New Serial Number only for Inverter
  function toggleControlCardChangedSection() {
    var outwardObject = document.getElementById('outwardObject').value;
    var controlCardSection = document.getElementById('controlCardChangedSection');
    var controlCardChanged = document.getElementById('controlCardChanged');
    var newSerialDiv = document.getElementById('newSerialNumberDiv');
    if (controlCardSection) {
      if (outwardObject === 'Inverter') {
        controlCardSection.style.display = '';
      } else {
        controlCardSection.style.display = 'none';
        if (controlCardChanged) controlCardChanged.value = '';
        if (newSerialDiv) {
          newSerialDiv.style.display = 'none';
          var nsn = document.getElementById('newSerialNumber');
          if (nsn) nsn.value = '';
        }
      }
    }
  }

  document.getElementById('outwardObject').addEventListener('change', function() {
    toggleControlCardChangedSection();
  });

  // Show/hide New Serial Number, Replacement Type, and Inward Inverter ID based on logic
  document.addEventListener('DOMContentLoaded', function() {
    var controlCardChanged = document.getElementById('controlCardChanged');
    var newSerialDiv = document.getElementById('newSerialNumberDiv');
    var newSerialInput = document.getElementById('newSerialNumber');
    var replacementTypeDiv = document.getElementById('replacementTypeDiv');
    var replacementType = document.getElementById('replacementType');
    var inwardInverterIdDiv = document.getElementById('inwardInverterIdDiv');
    var inverterIdInward = document.getElementById('inverterIdInward');
    var outwardObject = document.getElementById('outwardObject');

    function updateConditionalFields() {
      // Show/hide New Serial Number based on Control Card Changed
      if (controlCardChanged && newSerialDiv && newSerialInput) {
        if (controlCardChanged.value === 'Yes') {
          newSerialDiv.style.display = '';
          newSerialInput.setAttribute('required', 'required');
        } else {
          newSerialDiv.style.display = 'none';
          newSerialInput.value = '';
          newSerialInput.removeAttribute('required');
        }
      }
      // Show/hide Replacement Type if Outward Object is Inverter
      if (replacementTypeDiv && outwardObject) {
        if (outwardObject.value === 'Inverter') {
          replacementTypeDiv.style.display = '';
          replacementType.setAttribute('required', 'required');
        } else {
          replacementTypeDiv.style.display = 'none';
          replacementType.value = '';
          replacementType.removeAttribute('required');
        }
      }
      // Show/hide Inward Inverter ID if Replacement Type is selected
      if (inwardInverterIdDiv && replacementType && inverterIdInward) {
        if (replacementType.value !== '') {
          inwardInverterIdDiv.style.display = '';
          inverterIdInward.setAttribute('required', 'required');
        } else {
          inwardInverterIdDiv.style.display = 'none';
          inverterIdInward.value = '';
          inverterIdInward.removeAttribute('required');
        }
      }
    }
    if (controlCardChanged) controlCardChanged.addEventListener('change', updateConditionalFields);
    if (replacementType) replacementType.addEventListener('change', updateConditionalFields);
    if (outwardObject) outwardObject.addEventListener('change', updateConditionalFields);
    updateConditionalFields(); // Initial state
    toggleControlCardChangedSection(); // Initial state
  });

// Accessories section show/hide logic
function toggleAccessoriesSection() {
  const outwardObject = document.querySelector('#outwardObject').value;
  const accessoriesSection = document.querySelector('.inverter-only .accessories-section');
  if (accessoriesSection) {
    accessoriesSection.style.display = (outwardObject === 'Inverter') ? '' : 'none';
    if (outwardObject !== 'Inverter') {
      accessoriesSection.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    }
  }
}

document.querySelector('#outwardObject').addEventListener('change', function() {
  toggleOutwardFields();
  toggleAccessoriesSection();
});

// Initial call to set correct state on page load
document.addEventListener('DOMContentLoaded', function() {
  toggleOutwardFields();
  toggleAccessoriesSection();
});

// Pincode autofill functionality
document.querySelector('input[name="pincode"]').addEventListener('input', function(e) {
  const pincode = e.target.value.trim();
  
  // Only fetch when pincode is exactly 6 digits
  if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
    // Show loading indicator
    const originalBg = e.target.style.backgroundColor;
    e.target.style.backgroundColor = '#fffacd';
    
    fetch(`https://api.postalpincode.in/pincode/${pincode}`)
      .then(response => response.json())
      .then(data => {
        e.target.style.backgroundColor = originalBg;
        
        if (data && data[0] && data[0].Status === 'Success' && data[0].PostOffice) {
          const postOffice = data[0].PostOffice[0];
          
          // Autofill State
          const stateSelect = document.querySelector('select[name="sent_to_state"]');
          if (stateSelect && postOffice.State) {
            stateSelect.disabled = false;
            // Try to match state name
            for (let option of stateSelect.options) {
              if (option.value.toLowerCase() === postOffice.State.toLowerCase()) {
                stateSelect.value = option.value;
                break;
              }
            }
            stateSelect.disabled = true;
          }
          
          // Autofill District
          const districtInput = document.querySelector('input[name="sent_to_district"]');
          if (districtInput && postOffice.District) {
            districtInput.value = postOffice.District;
          }
          
          // Autofill Address with Area/City info
          const addressInput = document.querySelector('input[name="sent_to_address"]');
          if (addressInput) {
            const area = postOffice.Name || '';
            const region = postOffice.Region || '';
            addressInput.value = area + (region && region !== area ? ', ' + region : '');
          }
        } else {
          console.log('Invalid pincode or no data found');
        }
      })
      .catch(error => {
        e.target.style.backgroundColor = originalBg;
        console.error('Error fetching pincode data:', error);
      });
  }
});

// Enable disabled fields before form submission
document.querySelector('form').setAttribute('novalidate', 'novalidate');
document.querySelector('form').addEventListener('submit', function(e) {
  // Enable all required fields before validation
  document.querySelectorAll('[required]').forEach(field => {
    field.disabled = false;
  });
  document.querySelector('select[name="sent_to_state"]').disabled = false;
});

// Show success message after redirect with ?success=1
const outwardParams = new URLSearchParams(window.location.search);
if (outwardParams.get('success') === '1') {
  alert('Thank you for filling this form. Your form was submitted successfully.');
  outwardParams.delete('success');
  const newUrl = `${window.location.pathname}${outwardParams.toString() ? '?' + outwardParams.toString() : ''}`;
  window.history.replaceState({}, '', newUrl);
}

// Dropdown-style autocomplete for Inverter ID ‚Äì Outward
(function() {
  const input = document.getElementById('inverterIdOutward');
  const suggestionBox = document.getElementById('dropdown-inverter-suggestions');
  let currentSuggestions = [];
  let selectedIndex = -1;

  function showSuggestions(suggestions) {
    suggestionBox.innerHTML = '';
    if (!suggestions.length) {
      suggestionBox.style.display = 'none';
      return;
    }
    suggestions.forEach((serial, idx) => {
      const div = document.createElement('div');
      div.textContent = serial;
      div.className = 'dropdown-item' + (idx === selectedIndex ? ' active' : '');
      div.addEventListener('mousedown', function(e) {
        e.preventDefault();
        input.value = serial;
        suggestionBox.style.display = 'none';
      });
      div.addEventListener('touchstart', function(e) {
        e.preventDefault();
        input.value = serial;
        suggestionBox.style.display = 'none';
      });
      suggestionBox.appendChild(div);
    });
    suggestionBox.style.display = 'block';
  }

  function fetchAndShowSuggestions(query) {
    if (query.length < 2) {
      showSuggestions([]);
      return;
    }
    fetch('/api/available-inverter-serials/')
      .then(response => response.json())
      .then(data => {
        if (data.serials && Array.isArray(data.serials)) {
          currentSuggestions = data.serials.filter(serial => serial.toLowerCase().includes(query.toLowerCase()));
          selectedIndex = -1;
          showSuggestions(currentSuggestions);
        } else {
          showSuggestions([]);
        }
      })
      .catch(err => {
        showSuggestions([]);
      });
  }

  input.addEventListener('input', function() {
    fetchAndShowSuggestions(input.value);
  });

  input.addEventListener('focus', function() {
    fetchAndShowSuggestions(input.value);
  });

  input.addEventListener('blur', function() {
    setTimeout(() => suggestionBox.style.display = 'none', 120);
  });

  // Keyboard navigation (desktop)
  input.addEventListener('keydown', function(e) {
    if (!currentSuggestions.length) return;
    if (e.key === 'ArrowDown') {
      selectedIndex = (selectedIndex + 1) % currentSuggestions.length;
      showSuggestions(currentSuggestions);
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      selectedIndex = (selectedIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
      showSuggestions(currentSuggestions);
      e.preventDefault();
    } else if (e.key === 'Enter') {
      if (selectedIndex >= 0 && selectedIndex < currentSuggestions.length) {
        input.value = currentSuggestions[selectedIndex];
        suggestionBox.style.display = 'none';
        e.preventDefault();
      }
    }
  });
})();

// Dropdown-style autocomplete for Battery ID ‚Äì Outward
(function() {
  const input = document.getElementById('batteryIdOutward');
  const suggestionBox = document.getElementById('dropdown-battery-suggestions');
  let currentSuggestions = [];
  let selectedIndex = -1;

  function showSuggestions(suggestions) {
    suggestionBox.innerHTML = '';
    if (!suggestions.length) {
      suggestionBox.style.display = 'none';
      return;
    }
    suggestions.forEach((serial, idx) => {
      const div = document.createElement('div');
      div.textContent = serial;
      div.className = 'dropdown-item' + (idx === selectedIndex ? ' active' : '');
      div.addEventListener('mousedown', function(e) {
        e.preventDefault();
        input.value = serial;
        suggestionBox.style.display = 'none';
      });
      div.addEventListener('touchstart', function(e) {
        e.preventDefault();
        input.value = serial;
        suggestionBox.style.display = 'none';
      });
      suggestionBox.appendChild(div);
    });
    suggestionBox.style.display = 'block';
  }

  function fetchAndShowSuggestions(query) {
    if (query.length < 2) {
      showSuggestions([]);
      return;
    }
    fetch('/api/available-battery-serials/')
      .then(response => response.json())
      .then(data => {
        if (data.serials && Array.isArray(data.serials)) {
          currentSuggestions = data.serials.filter(serial => serial.toLowerCase().includes(query.toLowerCase()));
          selectedIndex = -1;
          showSuggestions(currentSuggestions);
        } else {
          showSuggestions([]);
        }
      })
      .catch(err => {
        showSuggestions([]);
      });
  }

  input.addEventListener('input', function() {
    fetchAndShowSuggestions(input.value);
  });

  input.addEventListener('focus', function() {
    fetchAndShowSuggestions(input.value);
  });

  input.addEventListener('blur', function() {
    setTimeout(() => suggestionBox.style.display = 'none', 120);
  });

  // Keyboard navigation (desktop)
  input.addEventListener('keydown', function(e) {
    if (!currentSuggestions.length) return;
    if (e.key === 'ArrowDown') {
      selectedIndex = (selectedIndex + 1) % currentSuggestions.length;
      showSuggestions(currentSuggestions);
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      selectedIndex = (selectedIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
      showSuggestions(currentSuggestions);
      e.preventDefault();
    } else if (e.key === 'Enter') {
      if (selectedIndex >= 0 && selectedIndex < currentSuggestions.length) {
        input.value = currentSuggestions[selectedIndex];
        suggestionBox.style.display = 'none';
        e.preventDefault();
      }
    }
  });
})();
</script>

</body>
</html>
