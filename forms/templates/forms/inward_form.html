<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inward Tracking Form</title>
{% load static %}
<style>
/* Header */
.header {
  position: sticky;
  top: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px 40px;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 12px;
}


.logo-section img {
  height: 40px;
  filter: brightness(0) invert(1);
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  margin: 0;
  padding: 20px 0;
}
.form-container {
  max-width: 1100px;
  margin: 30px auto;
  background: #fff;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.top-button-bar {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

.top-button-bar button,
.top-button-bar a {
  padding: 10px 24px;
  border: 2px solid #667eea;
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  font-size: 15px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.top-button-bar button:hover,
.top-button-bar a:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}
h1 {
  text-align: center;
  color: #667eea;
  margin-bottom: 10px;
  font-size: 30px;
  font-weight: 700;
}
.note {
  text-align: center;
  color: #e74c3c;
  font-size: 13px;
  margin-bottom: 20px;
}
label {
  display: block;
  margin: 18px 0 8px;
  font-size: 14px;
  font-weight: 600;
  color: #333;
}
input, select {
  width: 100%;
  padding: 12px 14px;
  font-size: 14px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  box-sizing: border-box;
  background: #fafafa;
  transition: all 0.3s ease;
}
input:focus, select:focus {
  outline: none;
  border-color: #667eea;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 20px;
  padding-right: 36px;
}
button {
  width: 100%;
  margin-top: 28px;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  transition: all 0.3s ease;
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.back-buttons {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.back-button, .home-button {
  flex: 1;
  min-width: 150px;
  padding: 12px;
  border: 2px solid #667eea;
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  font-size: 16px;
  font-weight: 700;
  border-radius: 8px;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.back-button:hover, .home-button:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}

/* Conditional field visibility */
.inverter-only {
  display: none;
}

.battery-only {
  display: none;
}

.pcb-only {
  display: none;
}

/* Hide browser validation popups */
input:invalid {
  box-shadow: none;
}

input::-webkit-validation-bubble-message {
  display: none;
}

.inverter-only.show,
.battery-only.show,
.pcb-only.show {
  display: block;
}

@media (max-width: 600px) {
  .form-container {
    margin: 16px;
    padding: 24px;
  }
}
</style>
</head>

<body>

<div class="header">
  <div class="logo-section">
    <a href="/" style="text-decoration: none;">
      <img src="{% static 'admin/Images/logo-deye-300x225.webp' %}" alt="DEYE">
    </a>
  </div>
</div>

<form class="form-container" method="post">
{% csrf_token %}

<div class="top-button-bar">
  <button type="button" onclick="history.back()">‚Üê Go Back</button>
  <a href="/">üè† Back to Home</a>
</div>

<h1>Inward Tracking</h1>
<div class="note">* Indicates required question</div>
<div class="note" style="color:#667eea;">Inward ID will be generated automatically after submission.</div>
{% if form_errors %}
<div style="background:#fdecea;color:#611a15;border:1px solid #f5c6cb;padding:8px 12px;border-radius:6px;margin:12px 0;">
  <strong>There were errors with your submission:</strong>
  <ul style="margin:8px 0 0 16px;">
    {% for field, errors in form_errors.items %}
      <li><b>{{ field|capfirst }}</b>: {{ errors|join:', ' }}</li>
    {% endfor %}
  </ul>
  <div style="font-size:12px;opacity:.8;">Please correct them and submit again.</div>
</div>
{% endif %}

<label style="background:#e8f0fe;padding:12px;border-left:4px solid #667eea;border-radius:4px;font-size:16px;font-weight:700;">üîç AWB Number (Search & Auto-Fill)<span class="req">*</span></label>
<input type="text" class="awb-input" name="awb_lr_number" list="awb-suggestions" placeholder="Type AWB number to search and auto-fill details" required style="font-size:16px;font-weight:600;">
<div style="font-size:12px;color:#666;margin:6px 0 20px 0;">Enter the AWB/LR number from your logistics booking. Details will automatically populate below.</div>

<div id="awb-item-container" style="display:none; margin:-6px 0 20px 0;">
  <label style="background:#fff7ed;padding:10px;border-left:4px solid #fb923c;border-radius:4px;font-size:14px;font-weight:700;">üì¶ Select Item For This AWB<span class="req">*</span></label>
  <select id="awb-item-select" style="margin-top:8px;" disabled>
    <option value="">Select item</option>
  </select>
  <div style="font-size:12px;color:#7c2d12;margin-top:6px;">This AWB has multiple shipped items. Select one to auto-fill exact inward details.</div>
</div>

<label>Customer Abbreviation <span class="req">*</span></label>
<select name="customer_abbrev" required>
  <option value="">Select</option>
   <option>Alternative Energy</option>
        <option>Aps</option>
        <option>Arkay Solar</option>
        <option>Avirat Energy</option>
        <option>Brither World Engineering Works</option>
        <option>Banglore</option>
        <option>Ceyone Solar</option>
        <option>Chetanbhai Trimandir</option>
        <option>Deye</option>
        <option>Eco Active Energy & Solution</option>
        <option>Envest Energy Solutions Llp</option>
        <option>Evaanta Solar</option>
        <option>Evvo</option>
        <option>Ferus Solar Energy Solution</option>
        <option>Feston</option>
        <option>Fine Vibes Renewable Pvt Ltd (Cg)</option>
        <option>Glowx</option>
        <option>Green Energy</option>
        <option>Green Era</option>
        <option>Green Watt Energy</option>
        <option>Greenedge</option>
        <option>Gujarat Energy</option>
        <option>Invergy</option>
        <option>Jaffins Enterprise</option>
        <option>Jay Aditya Solar</option>
        <option>Kerala Office</option>
        <option>Ksolare</option>
        <option>Madhav Enterprise</option>
        <option>Madhya Pradesh Solar9</option>
        <option>Mindra</option>
        <option>Mp Engineering</option>
        <option>Navi Energy</option>
        <option>Next Tech Solar Energy</option>
        <option>Nil Electronics</option>
        <option>Nk Construction</option>
        <option>Powerone</option>
        <option>Pushan Renewable Energy Pvt Ltd</option>
        <option>Radiant Sun Energy</option>
        <option>Railway Station Dhanera</option>
        <option>Roshni Solar</option>
        <option>Rudra Solar</option>
        <option>Saan Electrical</option>
        <option>Shantimani Enterprises</option>
        <option>Smart Solar Bidgely Solution Pvt Ltd</option>
        <option>Solaryaan</option>
        <option>Suntech Energy</option>
        <option>Swami Solar</option>
        <option>Symbroz Solar  Pvt Ltd</option>
        <option>Tecnogoods Energy</option>
        <option>Trambaka Solar  Pvt Ltd</option>
        <option>Urja Strot</option>
        <option>Utl</option>
        <option>Utl Solar</option>
        <option>Vsole</option>
        <option>Waaree</option>
        <option>Water Sun Solar</option>
        <option>Watthut</option>
        <option>Yamas Solar</option>
        <option>Other</option>
</select>

<label>Customer Name <span class="req">*</span></label>
<input type="text" name="customer_name" required>

<label>Received By <span class="req">*</span></label>
<select name="received_by" required>
  <option value="">Select</option>
  <option>Shrikant</option>
  <option>Rushikesh</option>
  <option>Sagar K</option>
  <option>Tanaji</option>
  <option>Arun</option>
  <option>Vinayak</option>
  <option>Nikhil</option>
  <option>Ramesh</option>
  <option>Bhuvan</option>
  <option>Sanjay</option>
  <option>Sandeep</option>
  <option>Sagar W</option>
  <option>Mohit</option>
  <option>Mukesh</option>
  <option>Jayesh</option>
  <option>Kankan</option>
  <option>Pranav</option>
  <option>Vishal</option>
  <option>Vivek</option>
  <option>Rahul</option>
  <option>Harihara</option>
  <option>Ranjan</option>
  <option>Harpreet</option>
</select>


<label>Inward Object <span class="req">*</span></label>
<select name="inward_object" id="inwardObject" required>
  <option value="">Select</option>
  <option value="Inverter">Inverter</option>
  <option value="Battery">Battery</option>
  <option value="PCB">PCB</option>
</select>

<label>Pincode <span class="req">*</span></label>
<input type="text" name="pincode" required placeholder="Enter 6-digit pincode">
<div id="pincode-info" style="font-size:12px;color:#6b7280;margin-top:4px;display:none;"></div>

<label>Received From Location <span class="req">*</span></label>
<input type="text" name="received_from_location" required readonly style="background-color: #f0f0f0;">

<label>Received From District <span class="req">*</span></label>
<input type="text" name="received_from_district" required readonly style="background-color: #f0f0f0;">

<label>Received From State <span class="req">*</span></label>
<select name="received_from_state" required disabled style="background-color: #f0f0f0;">
  <option value="">Select</option>
  <option>Andhra Pradesh</option>
  <option>Arunachal Pradesh</option>
  <option>Assam</option>
  <option>Bihar</option>
  <option>Chhattisgarh</option>
  <option>Goa</option>
  <option>Gujarat</option>
  <option>Haryana</option>
  <option>Himachal Pradesh</option>
  <option>Jharkhand</option>
  <option>Karnataka</option>
  <option>Kerala</option>
  <option>Madhya Pradesh</option>
  <option>Maharashtra</option>
  <option>Manipur</option>
  <option>Meghalaya</option>
  <option>Mizoram</option>
  <option>Nagaland</option>
  <option>Odisha</option>
  <option>Punjab</option>
  <option>Rajasthan</option>
  <option>Sikkim</option>
  <option>Tamil Nadu</option>
  <option>Telangana</option>
  <option>Tripura</option>
  <option>Uttar Pradesh</option>
  <option>Uttarakhand</option>
  <option>West Bengal</option>
  <option>Other - Jammu & Kashmir</option>
</select>

<div class="inverter-only">
<label>Inverter ID <span class="req">*</span></label>
<input type="text" name="inverter_id" required>

<label>Inverter Specifications <span class="req">*</span></label>
<select name="inverter_specs" required>
  <option value="">Select</option>
  <option>1PH - Hybrid</option>
  <option>3PH - Hybrid</option>
  <option>1PH - Ongrid</option>
  <option>3PH - Ongrid</option>
  <option>All In One - Hybrid</option>
  <option>Micro Inverter</option>
</select>

<label>Inverter Ratings</label>
<select name="inverter_ratings">
  <option value="">Select</option>
  <option>2.2 KW</option>
  <option>3 KW</option>
  <option>3.3 KW</option>
  <option>4 KW</option>
  <option>5 KW</option>
  <option>6 KW</option>
  <option>8 KW</option>
  <option>10 KW</option>
  <option>12 KW</option>
  <option>15 KW</option>
  <option>18 KW</option>
  <option>20 KW</option>
  <option>25 KW</option>
  <option>30 KW</option>
  <option>33 KW</option>
  <option>35 KW</option>
  <option>40 KW</option>
  <option>50 KW</option>
  <option>60 KW</option>
  <option>75 KW</option>
  <option>80 KW</option>
  <option>100 KW</option>
  <option>125 KW</option>
  <option>136 KW</option>
</select>
</div>



<div class="battery-only">
  <label>Battery ID <span class="req">*</span></label>
  <input type="text" name="battery_id" required>

  <label>Battery Model</label>
  <select name="battery">
    <option value="">Select</option>
    <option>RW - L 2.5 Neutral</option>
    <option>RW - M 5.3 Neutral</option>
    <option>RW - M 5.3 Pro Neutral (M6)</option>
    <option>RW - M 6.1 Neutral</option>
    <option>RW - M 6.1 B Neutral No Remark</option>
    <option>SE - G 5.1 - Pro B Neutral No Remark</option>
    <option>AI - W 5.1 Neutral</option>
    <option>AI - W 5.1 - B Neutral No Remark</option>
    <option>BOS - GM 5.1 Neutral</option>
    <option>GB - LM 4.0 Neutral</option>
    <option>GB - LB Neutral</option>
    <option>SE - G 5.3</option>
    <option>SE - G 5.3 Pro</option>
    <option>SE - F 5</option>
    <option>Other</option>
  </select>
</div>

</div>

<div class="inverter-only">

<div class="accessories-section" style="margin-top:18px; margin-bottom:18px;">
  <label style="font-weight:600; font-size:15px; margin-bottom:8px; display:block;">Accessories Received With Inverter <span style="font-weight:400; color:#888; font-size:13px;">(Optional)</span></label>
  <div style="display:flex; gap:32px; align-items:center;">
    <div style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="accessory_data_logger" name="accessories" value="data_logger" style="margin:0;">
      <label for="accessory_data_logger" style="font-weight:400; font-size:14px; margin:0;">Data Logger</label>
    </div>
    <div style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="accessory_stand" name="accessories" value="stand" style="margin:0;">
      <label for="accessory_stand" style="font-weight:400; font-size:14px; margin:0;">Stand</label>
    </div>
  </div>
</div>

<label>No of MPPT</label>
<select name="no_of_mppt">
  <option value="">Select</option>
  <option>1</option>
  <option>2</option>
  <option>3</option>
  <option>4</option>
  <option>5</option>
  <option>6</option>
  <option>7</option>
  <option>8</option>
</select>

<label>Current/ MPPT</label>
<select name="current_mppt">
  <option value="">Select</option>
  <option>13</option>
  <option>18</option>
  <option>20</option>
  <option>40</option>
</select>

<label>Case Handled By</label>
<select name="case_handled_by">
  <option value="">Select</option>
  <option>Mr. Rakesh Kumar</option>
  <option>Mr. Pranav Rajeshbhai Dalwadi</option>
  <option>Mr. Prajapati Vishal Atmarambhai</option>
  <option>Mr. Bhuvan D</option>
  <option>Mr. Jayesh khodabhai Solanki</option>
  <option>Mr. Mahamadhusen Daud Mahagonde</option>
  <option>Mr. Ranjan kumar Yadav</option>
  <option>Mr. Mohit Kumawat</option>
  <option>Mr. Tirupathi Vasu</option>
  <option>Mr. Elson Eldo</option>
  <option>Mr. Arun Hanumantrao Kardile</option>
  <option>Mr. Sagar Prakash Katkar</option>
  <option>Mr. Uttam Naskar</option>
  <option>Mr. Tanaji Sampath Jadhav</option>
  <option>Mr. Shrikant Chandu Rathod</option>
  <option>Mr. Rushikesh Mohan Kolape</option>
  <option>Mr. Sagar LaxmanBhai Wagh</option>
  <option>Mr. Sanjay Kumar C N</option>
  <option>Mr. Harihara Vishnu Prabu B</option>
  <option>Mr. Sandeep Kumar</option>
  <option>Mr. Harpreet Singh</option>
  <option>Mr. Kankan Mandal</option>
  <option>Mr. Mukesh Kumar</option>
  <option>Mr. Rahul Saini</option>
  <option>Mr. Anandhu Anil</option>
</select>
</div>
</div>

<div class="inverter-only">
<label>Reason Of Inward</label>
<select name="reason" required>
  <option value="">Select</option>
  <option>For Stand By</option>
  <option>For Return After Repairing</option>
</select>

<label>Transportation Mode <span class="req">*</span></label>
<select name="transportation_mode" required>
  <option value="">Select</option>
  <option>Bigship</option>
  <option>Blue Dart</option>
  <option>Anjani</option>
  <option>Delhivery</option>
  <option>Safexpress</option>
  <option>Global Cargo</option>
  <option>Other</option>
</select>

<label>Invoice Number <span class="req">*</span></label>
<input type="text" name="invoice_number" required>
</div>

<div class="battery-only">
<label>Case Handled By</label>
<select name="case_handled_by">
  <option value="">Select</option>
  <option>Mr. Rakesh Kumar</option>
  <option>Mr. Pranav Rajeshbhai Dalwadi</option>
  <option>Mr. Prajapati Vishal Atmarambhai</option>
  <option>Mr. Bhuvan D</option>
  <option>Mr. Jayesh khodabhai Solanki</option>
  <option>Mr. Mahamadhusen Daud Mahagonde</option>
  <option>Mr. Ranjan kumar Yadav</option>
  <option>Mr. Mohit Kumawat</option>
  <option>Mr. Tirupathi Vasu</option>
  <option>Mr. Elson Eldo</option>
  <option>Mr. Arun Hanumantrao Kardile</option>
  <option>Mr. Sagar Prakash Katkar</option>
  <option>Mr. Uttam Naskar</option>
  <option>Mr. Tanaji Sampath Jadhav</option>
  <option>Mr. Shrikant Chandu Rathod</option>
  <option>Mr. Rushikesh Mohan Kolape</option>
  <option>Mr. Sagar LaxmanBhai Wagh</option>
  <option>Mr. Sanjay Kumar C N</option>
  <option>Mr. Harihara Vishnu Prabu B</option>
  <option>Mr. Sandeep Kumar</option>
  <option>Mr. Harpreet Singh</option>
  <option>Mr. Kankan Mandal</option>
  <option>Mr. Mukesh Kumar</option>
  <option>Mr. Rahul Saini</option>
  <option>Mr. Anandhu Anil</option>
</select>

<label>Reason Of Inward</label>
<select name="reason" required>
  <option value="">Select</option>
  <option>For Stand By</option>
  <option>For Return After Repairing</option>
</select>

<label>Transportation Mode <span class="req">*</span></label>
<select name="transportation_mode" required>
  <option value="">Select</option>
  <option>Bigship</option>
  <option>Blue Dart</option>
  <option>Anjani</option>
  <option>Delhivery</option>
  <option>Safexpress</option>
  <option>Global Cargo</option>
  <option>Other</option>
</select>

<label>Invoice Number <span class="req">*</span></label>
<input type="text" name="invoice_number" required>
</div>

<div class="pcb-only">
<label>PCB Serial Number <span class="req">*</span></label>
<input type="text" name="pcb_serial_number" required>

<label>No of Quantity <span class="req">*</span></label>
<input type="number" name="pcb_quantity" required min="1">

<label>PCB Ratings</label>
<select name="pcb_ratings">
  <option value="">Select</option>
  <option>2.2 KW</option>
  <option>3 KW</option>
  <option>3.3 KW</option>
  <option>4 KW</option>
  <option>5 KW</option>
  <option>6 KW</option>
  <option>8 KW</option>
  <option>10 KW</option>
  <option>12 KW</option>
  <option>15 KW</option>
  <option>18 KW</option>
  <option>20 KW</option>
  <option>25 KW</option>
  <option>30 KW</option>
  <option>33 KW</option>
  <option>35 KW</option>
  <option>40 KW</option>
  <option>50 KW</option>
  <option>60 KW</option>
  <option>75 KW</option>
  <option>80 KW</option>
  <option>100 KW</option>
  <option>125 KW</option>
  <option>136 KW</option>
</select>

<label>PCB Specifications</label>
<select name="pcb_specifications">
  <option value="">Select</option>
  <option>1PH - Hybrid</option>
  <option>3PH - Hybrid</option>
  <option>1PH - Ongrid</option>
  <option>3PH - Ongrid</option>
  <option>All In One - Hybrid</option>
  <option>Micro Inverter</option>
</select>

<label>Case Handled By</label>
<select name="case_handled_by">
  <option value="">Select</option>
  <option>Mr. Rakesh Kumar</option>
  <option>Mr. Pranav Rajeshbhai Dalwadi</option>
  <option>Mr. Prajapati Vishal Atmarambhai</option>
  <option>Mr. Bhuvan D</option>
  <option>Mr. Jayesh khodabhai Solanki</option>
  <option>Mr. Mahamadhusen Daud Mahagonde</option>
  <option>Mr. Ranjan kumar Yadav</option>
  <option>Mr. Mohit Kumawat</option>
  <option>Mr. Tirupathi Vasu</option>
  <option>Mr. Elson Eldo</option>
  <option>Mr. Arun Hanumantrao Kardile</option>
  <option>Mr. Sagar Prakash Katkar</option>
  <option>Mr. Uttam Naskar</option>
  <option>Mr. Tanaji Sampath Jadhav</option>
  <option>Mr. Shrikant Chandu Rathod</option>
  <option>Mr. Rushikesh Mohan Kolape</option>
  <option>Mr. Sagar LaxmanBhai Wagh</option>
  <option>Mr. Sanjay Kumar C N</option>
  <option>Mr. Harihara Vishnu Prabu B</option>
  <option>Mr. Sandeep Kumar</option>
  <option>Mr. Harpreet Singh</option>
  <option>Mr. Kankan Mandal</option>
  <option>Mr. Mukesh Kumar</option>
  <option>Mr. Rahul Saini</option>
  <option>Mr. Anandhu Anil</option>
</select>

<label>Transportation Mode <span class="req">*</span></label>
<select name="transportation_mode" required>
  <option value="">Select</option>
  <option>Bigship</option>
  <option>Blue Dart</option>
  <option>Anjani</option>
  <option>Delhivery</option>
  <option>Safexpress</option>
  <option>Global Cargo</option>
  <option>Other</option>
</select>

<label>Invoice Number <span class="req">*</span></label>
<input type="text" name="invoice_number" required>
</div>

<button type="submit">Submit</button>

<datalist id="awb-suggestions"></datalist>

</form>

<script>
const awbInputs = document.querySelectorAll('.awb-input');
const awbDatalist = document.getElementById('awb-suggestions');
const awbItemContainer = document.getElementById('awb-item-container');
const awbItemSelect = document.getElementById('awb-item-select');
let awbItemsCache = [];

function normalizeText(value) {
  return (value || '').toString().trim().toLowerCase().replace(/\s+/g, ' ').replace(/-/g, ' ').replace(/_/g, ' ');
}

function selectByValueOrText(selectEl, rawValue) {
  if (!selectEl || !rawValue) return false;
  const wanted = normalizeText(rawValue);
  for (const option of selectEl.options) {
    const optionValue = normalizeText(option.value);
    const optionText = normalizeText(option.text);
    if (optionValue === wanted || optionText === wanted) {
      selectEl.value = option.value;
      return true;
    }
  }
  return false;
}

function buildAwbItemLabel(item, index) {
  const parts = [];
  parts.push(`Item ${index + 1}`);
  if (item.object_type) parts.push(item.object_type);
  if (item.object_variant) parts.push(item.object_variant);
  if (item.object_capacity) parts.push(item.object_capacity);
  if (item.object_serial_number) parts.push(`SN: ${item.object_serial_number}`);
  if (item.object_quantity) parts.push(`Qty: ${item.object_quantity}`);
  return parts.join(' | ');
}

function resetAwbItemSelector() {
  awbItemsCache = [];
  if (!awbItemSelect) return;
  awbItemSelect.innerHTML = '<option value="">Select item</option>';
  awbItemSelect.disabled = true;
  if (awbItemContainer) awbItemContainer.style.display = 'none';
}

function renderAwbItemSelector(items) {
  if (!awbItemSelect) return;
  awbItemsCache = Array.isArray(items) ? items : [];

  if (awbItemsCache.length <= 1) {
    awbItemSelect.innerHTML = '<option value="">Select item</option>';
    awbItemSelect.disabled = true;
    if (awbItemContainer) awbItemContainer.style.display = 'none';
    return;
  }

  awbItemSelect.innerHTML = '<option value="">Select item</option>';
  awbItemsCache.forEach((item, idx) => {
    const option = document.createElement('option');
    option.value = String(item.booking_id || idx);
    option.dataset.index = String(idx);
    option.textContent = buildAwbItemLabel(item, idx);
    awbItemSelect.appendChild(option);
  });
  awbItemSelect.disabled = false;
  if (awbItemContainer) awbItemContainer.style.display = 'block';
}

function fillFromAwb(detail) {
  if (!detail) return;
  const invoiceInputs = document.querySelectorAll('input[name="invoice_number"]');
  invoiceInputs.forEach(input => { input.value = detail.invoice_number || ''; });

  const customerName = document.querySelector('input[name="customer_name"]');
  if (customerName && detail.customer_name) customerName.value = detail.customer_name;

  const pincode = document.querySelector('input[name="pincode"]');
  if (pincode && detail.pickup_pincode) pincode.value = detail.pickup_pincode;

  const state = document.querySelector('select[name="received_from_state"]');
  if (state && detail.pickup_state) {
    for (let option of state.options) {
      if (option.value.toLowerCase() === detail.pickup_state.toLowerCase()) {
        state.value = option.value;
        break;
      }
    }
  }

  const district = document.querySelector('input[name="received_from_district"]');
  if (district && detail.pickup_district) district.value = detail.pickup_district;

  const location = document.querySelector('input[name="received_from_location"]');
  if (location) {
    location.value = detail.pickup_city || detail.pickup_address || location.value;
  }

  const inwardObject = document.querySelector('#inwardObject');
  if (inwardObject && detail.object_type) {
    if (selectByValueOrText(inwardObject, detail.object_type)) {
      if (typeof toggleInwardFields === 'function') {
        toggleInwardFields();
      }
    }
  }

  const transportSelects = document.querySelectorAll('select[name="transportation_mode"]');
  if (transportSelects.length && detail.courier_partner) {
    transportSelects.forEach((transport) => {
      if (!selectByValueOrText(transport, detail.courier_partner)) {
        selectByValueOrText(transport, 'Other');
      }
    });
  }

  const inverterId = document.querySelector('input[name="inverter_id"]');
  if (inverterId && detail.object_type === 'Inverter' && detail.object_serial_number) {
    inverterId.value = detail.object_serial_number;
  }

  const inverterSpecs = document.querySelector('select[name="inverter_specs"]');
  if (inverterSpecs && detail.object_variant && detail.object_type === 'Inverter') {
    selectByValueOrText(inverterSpecs, detail.object_variant);
  }

  const inverterRatings = document.querySelector('select[name="inverter_ratings"]');
  if (inverterRatings && detail.object_capacity && detail.object_type === 'Inverter') {
    selectByValueOrText(inverterRatings, detail.object_capacity);
  }

  const batteryId = document.querySelector('input[name="battery_id"]');
  if (batteryId && detail.object_type === 'Battery' && detail.object_serial_number) {
    batteryId.value = detail.object_serial_number;
  }

  const batteryModel = document.querySelector('select[name="battery"]');
  if (batteryModel && detail.object_variant && detail.object_type === 'Battery') {
    selectByValueOrText(batteryModel, detail.object_variant);
  }

  const pcbSerial = document.querySelector('input[name="pcb_serial_number"]');
  if (pcbSerial && detail.object_type === 'PCB' && detail.object_serial_number) {
    pcbSerial.value = detail.object_serial_number;
  }

  const pcbQty = document.querySelector('input[name="pcb_quantity"]');
  if (pcbQty && detail.object_type === 'PCB' && detail.object_quantity) {
    pcbQty.value = detail.object_quantity;
  }

  const pcbSpecs = document.querySelector('select[name="pcb_specifications"]');
  if (pcbSpecs && detail.object_variant && detail.object_type === 'PCB') {
    selectByValueOrText(pcbSpecs, detail.object_variant);
  }

  const pcbRatings = document.querySelector('select[name="pcb_ratings"]');
  if (pcbRatings && detail.object_capacity && detail.object_type === 'PCB') {
    selectByValueOrText(pcbRatings, detail.object_capacity);
  }
}

function updateAwbSuggestions(value) {
  if (!value) {
    awbDatalist.innerHTML = '';
    resetAwbItemSelector();
  }
  fetch('/api/awb-lookup/?q=' + encodeURIComponent(value))
    .then(r => r.ok ? r.json() : Promise.reject(r))
    .then(j => {
      if (j && j.ok) {
        awbDatalist.innerHTML = '';
        (j.suggestions || []).forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          awbDatalist.appendChild(opt);
        });
        const items = Array.isArray(j.items) ? j.items : [];
        renderAwbItemSelector(items);

        if (items.length === 1) {
          fillFromAwb(items[0]);
        } else if (items.length === 0 && j.detail) {
          fillFromAwb(j.detail);
        }
      }
    })
    .catch(err => {
      console.error('AWB lookup error:', err);
    });
}

awbInputs.forEach(input => {
  input.setAttribute('autocomplete', 'off');

  input.addEventListener('focus', (e) => {
    updateAwbSuggestions(e.target.value || '');
  });

  input.addEventListener('input', (e) => {
    updateAwbSuggestions(e.target.value);
  });

  // When user selects from datalist, fetch the full details
  input.addEventListener('change', (e) => {
    const selectedValue = e.target.value;
    if (selectedValue && selectedValue.length > 0) {
      // Fetch details for the selected AWB
      fetch('/api/awb-lookup/?q=' + encodeURIComponent(selectedValue))
        .then(r => r.ok ? r.json() : Promise.reject(r))
        .then(j => {
          if (!j || !j.ok) return;
          const items = Array.isArray(j.items) ? j.items : [];
          renderAwbItemSelector(items);

          if (items.length === 1) {
            fillFromAwb(items[0]);
          } else if (items.length === 0 && j.detail) {
            fillFromAwb(j.detail);
          }
        })
        .catch(err => {
          console.error('AWB detail fetch error:', err);
        });
    }
  });
});

if (awbItemSelect) {
  awbItemSelect.addEventListener('change', (e) => {
    const selectedIndex = e.target.selectedOptions && e.target.selectedOptions[0]
      ? Number(e.target.selectedOptions[0].dataset.index)
      : -1;
    if (selectedIndex >= 0 && awbItemsCache[selectedIndex]) {
      fillFromAwb(awbItemsCache[selectedIndex]);
    }
  });
}

// Toggle conditional fields based on Inward Object selection
function toggleInwardFields() {
  const inwardObject = document.querySelector('#inwardObject').value;
  const inverterFields = document.querySelectorAll('.inverter-only');
  const batteryFields = document.querySelectorAll('.battery-only');
  const pcbFields = document.querySelectorAll('.pcb-only');
  const inverterInputs = document.querySelectorAll('.inverter-only input, .inverter-only select, .inverter-only textarea');
  const batteryInputs = document.querySelectorAll('.battery-only input, .battery-only select, .battery-only textarea');
  const pcbInputs = document.querySelectorAll('.pcb-only input, .pcb-only select, .pcb-only textarea');

  function setRequired(nodes, shouldRequire) {
    nodes.forEach((el) => {
      if (!el) return;
      // Never set required for accessories checkboxes
      if (el.type === 'checkbox' && el.name === 'accessories') {
        el.removeAttribute('required');
        return;
      }
      if (shouldRequire) {
        el.setAttribute('required', 'required');
      } else {
        el.removeAttribute('required');
      }
    });
  }

  function setDisabled(nodes, shouldDisable) {
    nodes.forEach((el) => {
      if (!el) return;
      // Don't disable the pincode/state/district/location shared fields here
      el.disabled = shouldDisable;
      if (shouldDisable) {
        // Clear values so they don't interfere if re-enabled later accidentally
        if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else if (el.type === 'checkbox' || el.type === 'radio') {
          el.checked = false;
        } else {
          el.value = '';
        }
      }
    });
  }
  
  inverterFields.forEach(field => {
    field.classList.remove('show');
  });
  batteryFields.forEach(field => {
    field.classList.remove('show');
  });
  pcbFields.forEach(field => {
    field.classList.remove('show');
  });
  
  if (inwardObject === 'Inverter') {
    inverterFields.forEach(field => {
      field.classList.add('show');
    });
  } else if (inwardObject === 'Battery') {
    batteryFields.forEach(field => {
      field.classList.add('show');
    });
  } else if (inwardObject === 'PCB') {
    pcbFields.forEach(field => {
      field.classList.add('show');
    });
  }

  // Only require fields for the active object
  setRequired(inverterInputs, inwardObject === 'Inverter');
  setRequired(batteryInputs, inwardObject === 'Battery');
  setRequired(pcbInputs, inwardObject === 'PCB');

  // Disable hidden section inputs to avoid duplicate-name collisions in POST
  setDisabled(inverterInputs, inwardObject !== 'Inverter');
  setDisabled(batteryInputs, inwardObject !== 'Battery');
  setDisabled(pcbInputs, inwardObject !== 'PCB');
}


// Accessories checkboxes are fully optional; no validation or warning required.
document.querySelector('#inwardObject').addEventListener('change', function() {
  toggleInwardFields();
});

// Pincode autofill functionality (original behavior) + show city/state line
document.querySelector('input[name="pincode"]').addEventListener('input', function(e) {
  const pincode = e.target.value.trim();
  const info = document.getElementById('pincode-info');
  if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
    const originalBg = e.target.style.backgroundColor;
    e.target.style.backgroundColor = '#fffacd';
    fetch(`https://api.postalpincode.in/pincode/${pincode}`)
      .then(response => response.json())
      .then(data => {
        e.target.style.backgroundColor = originalBg;
        if (data && data[0] && data[0].Status === 'Success' && data[0].PostOffice) {
          const postOffice = data[0].PostOffice[0];

          // Autofill State
          const stateSelect = document.querySelector('select[name="received_from_state"]');
          if (stateSelect && postOffice.State) {
            stateSelect.disabled = false;
            for (let option of stateSelect.options) {
              if (option.value.toLowerCase() === postOffice.State.toLowerCase()) {
                stateSelect.value = option.value;
                break;
              }
            }
            stateSelect.disabled = true;
          }

          // Autofill District
          const districtInput = document.querySelector('input[name="received_from_district"]');
          if (districtInput && postOffice.District) {
            districtInput.value = postOffice.District;
          }

          // Autofill Location with Area/City info
          const locationInput = document.querySelector('input[name="received_from_location"]');
          if (locationInput) {
            const area = postOffice.Name || '';
            const region = postOffice.Region || '';
            locationInput.value = area + (region && region !== area ? ', ' + region : '');
          }

          // Show City/State hint
          if (info) {
            info.style.display = 'block';
            const city = postOffice.District || postOffice.Name || '-';
            const state = postOffice.State || '-';
            info.textContent = `City: ${city}  |  State: ${state}`;
          }
        } else {
          if (info) { info.style.display = 'block'; info.textContent = 'Pincode not found'; info.style.color = '#b91c1c'; }
        }
      })
      .catch(error => {
        e.target.style.backgroundColor = originalBg;
        if (info) { info.style.display = 'block'; info.textContent = 'Error fetching pincode data'; info.style.color = '#b91c1c'; }
      });
  } else {
    if (info) { info.style.display = 'none'; info.textContent = ''; }
  }
});

// Enable disabled fields before form submission
document.querySelector('form').addEventListener('submit', function(e) {
  document.querySelector('select[name="received_from_state"]').disabled = false;
});

// Show success message after redirect with ?success=1
const inwardParams = new URLSearchParams(window.location.search);
if (inwardParams.get('success') === '1') {
  alert('Thank you for filling this form. Your form was submitted successfully.');
  inwardParams.delete('success');
  const newUrl = `${window.location.pathname}${inwardParams.toString() ? '?' + inwardParams.toString() : ''}`;
  window.history.replaceState({}, '', newUrl);
}
</script>

</body>
</html>
